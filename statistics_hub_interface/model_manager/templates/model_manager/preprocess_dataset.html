{% load static %}

{% block head %}
<style>
    body {
        background-color: #f4f4f4; 
    }

    .form-section, #eda-view, #preprocessing-view {
        margin-top: 20px;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
    }

    .form-group {
        margin-bottom: 10px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input, 
    .form-group select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .form-group button, .view-selector button {
        background-color: #4CAF50; /* Green */
        color: white;
        padding: 14px 20px;
        margin: 8px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .form-group button:hover, .view-selector button:hover {
        background-color: #45a049;
    }

    .view-selector {
        text-align: center;
        margin-bottom: 20px;
    }

    #table-preview-view, #eda-view, #preprocessing-view {
        display: none;
    }

</style>
<!-- Añadir jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<!-- Añadir DataTables CSS y JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>

<!-- Añadir Flatpickr CSS y JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<!-- Formulario oculto para el token CSRF -->
<form id="csrf-form" method="post" style="display: none;">
    {% csrf_token %}
</form>
<div class="container">
    <div class="view-selector">
        <button id="show-table-preview">Table Preview</button>
        <button id="show-eda-view">EDA</button>
        <button id="show-preprocessing-view">Preprocessing</button>
    </div>

    <!-- Sección de Vista Previa de la Tabla -->
    <div class="form-section" id="table-preview-view">
        <ul>
            <li> #ToDo: Continuar con la carga "perezosa" de los datos y manetener la estética de los Datatables. 
                 Actualmente se muestran solo las primeras 1000 filas. </li>
        </ul>
        {{ df_html|safe }}
    </div>

    <!-- Sección de EDA (Exploratory Data Analysis) -->
    <div class="form-section" id="eda-view" style="display:none;">
        <!-- Selección de Columna Timestamp -->
        <div class="form-group">
            <label for="timestamp-column">Select temporal column:</label>
            <select id="timestamp-column" name="timestamp_column" class="form-control">
                <option value="">--Select temporal column--</option>
                {% for column in columns %}
                <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Rango de Fechas -->
        <div class="form-group">
            <label for="date-range" id="date-range-label">Select Date Range (In dataset: computing range of dataset...):</label>
            <input type="text" id="date-range" name="date_range" class="date-range-selector">
        </div>

        <!-- Área de Filtros Dinámicos -->
        <div class="form-group">
            <label for="dynamic-filters">Filters:</label>
            <div id="dynamic-filters">
                <!-- Los filtros se añadirán aquí dinámicamente -->
            </div>
            <button type="button" id="add-filter">Add Filter</button>
        </div>
        <!-- Botón de Envío -->
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Analyze</button>
        </div>
    </div>

    <!-- Sección de Preprocesamiento -->
    <div class="form-section" id="preprocessing-view" style="display:none;">
        <!-- Contenido de Preprocesamiento aquí -->
    </div>
</div>

<script>
    $(document).ready(function() {
        // Inicialización inicial de flatpickr: Calendario para el rango de fechas
        var flatpickrInstance = $(".date-range-selector").flatpickr({
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: ["{{ min_date_dataset }}", "{{ max_date_dataset }}"],
            onChange: function(selectedDates, dateStr, instance) {
                // Enviar solicitud AJAX cuando el usuario cambia el rango de fechas
                sendAjaxRequestWithDates(dateStr);
            }
        });

        // Función para inicializar DataTable
        function initializeDataTable() {
            // Verificar si la tabla ya está inicializada como DataTable
            if ($.fn.DataTable.isDataTable('#table-preview-view .my-data-table')) {
                // Destruir la instancia existente si ya está inicializada
                $('#table-preview-view .my-data-table').DataTable().destroy();
            }
            // Inicializar DataTable
            $('#table-preview-view .my-data-table').DataTable({
                // Opciones de configuración de DataTables, si es necesario
            });
        }

        // Función para mostrar u ocultar elementos de EDA
        function toggleEdaElements() {
            var selectedColumn = $('#timestamp-column').val();
            if (selectedColumn) {
                $('#eda-view .form-group:not(:first)').show(); 
            } else {
                $('#eda-view .form-group:not(:first)').hide();
            }
        }

        function addFilter() {
            // Crear el contenedor para el nuevo filtro
            var filterContainer = $('<div class="filter-container" style="margin-bottom: 10px;"></div>');
            
            // Crear y añadir el desplegable para seleccionar la columna
            var selectColumn = $('<select class="form-control filter-column-select"><option value="">--Select categorical column--</option></select>');
            {% for column in columns %}
            selectColumn.append($('<option>').attr('value', '{{ column }}').text('{{ column }}'));
            {% endfor %}
            filterContainer.append(selectColumn);
            
            // Añadir un contenedor para los checkboxes de categorías (se llenará dinámicamente)
            var categoryCheckboxes = $('<div class="category-checkboxes" style="display: flex; flex-wrap: wrap; margin-top: 10px;"></div>');
            filterContainer.append(categoryCheckboxes);
        
            // Añadir un botón de eliminar al filtro
            var deleteButton = $('<button type="button" class="delete-filter-btn">Delete</button>')
            .css({
                "background-color": "#ff4d4d", // Rojo
                "color": "white",
                "border": "none",
                "padding": "5px 10px",
                "margin-left": "10px",
                "border-radius": "4px",
                "cursor": "pointer"
            });
        
            // Agregar efecto hover al botón de eliminar
            deleteButton.hover(
                function() {
                    $(this).css("background-color", "#ff3333"); // Rojo más oscuro al pasar el mouse
                }, 
                function() {
                    $(this).css("background-color", "#ff4d4d"); // Color original al quitar el mouse
                }
            );
            filterContainer.append(deleteButton);
            
            // Añadir el filtro al DOM
            $('#dynamic-filters').append(filterContainer);
        }

        $('#add-filter').click(addFilter);

        function collectSelectedCategories() {
            var filters = {};
        
            $('.filter-container').each(function() {
                var columnName = $(this).find('.filter-column-select').val();
                if (columnName) {
                    var selectedCategories = [];
                    $(this).find('.category-checkboxes input:checked').each(function() {
                        selectedCategories.push($(this).val());
                    });
                    if (selectedCategories.length > 0) {
                        filters[columnName] = selectedCategories;
                    }
                }
            });
        
            return filters;
        }

        $(document).on('click', '.delete-filter-btn', function() {
            $(this).parent('.filter-container').remove();
        });

        $(document).on('change', '.filter-column-select', function() {
            var selectedColumn = $(this).val();
            var categoryCheckboxesContainer = $(this).next('.category-checkboxes');
            categoryCheckboxesContainer.empty();
        
            // Utilizar la función existente para construir la URL de la solicitud AJAX
            var ajaxUrl = buildAjaxUrl();
        
            // Enviar la solicitud AJAX para obtener las categorías únicas de la columna seleccionada
            $.ajax({
                url: ajaxUrl,
                type: 'GET',
                data: {
                    'get_categories': 'true',
                    'column_name': selectedColumn
                },
                success: function(response) {
                    console.log("Respuesta AJAX 2:", response);
                    if (response.categories) {
                        // Si la respuesta contiene categorías, crear checkboxes para ellas
                        response.categories.forEach(function(category) {
                            var checkbox = $('<div><label><input type="checkbox" value="' + category + '"> ' + category + '</label></div>');
                            categoryCheckboxesContainer.append(checkbox);
                        });
                    } else if (response.error) {
                        // Manejar el caso en que se devuelva un error
                        console.error("Error al obtener categorías:", response.error);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error en la solicitud AJAX:", error);
                }
            });

            // Agregar 'name' a los checkboxes basado en el nombre de la columna
            var checkboxName = 'filter_' + selectedColumn;
            response.categories.forEach(function(category) {
                var checkbox = $('<div><label><input type="checkbox" name="' + checkboxName + '" value="' + category + '"> ' + category + '</label></div>');
                categoryCheckboxesContainer.append(checkbox);
            });

        });

        // Eventos de clic para manejar la vista activa
        $('#show-table-preview').click(function() {
            $('#table-preview-view').show();
            $('#eda-view, #preprocessing-view').hide();
            initializeDataTable(); // Asegurarse de que DataTable se inicializa correctamente
        });

        $('#show-eda-view').click(function() {
            $('#eda-view').show();
            $('#table-preview-view, #preprocessing-view').hide();
            toggleEdaElements(); // Ajustar la visibilidad de los elementos de EDA
        });

        $('#show-preprocessing-view').click(function() {
            $('#preprocessing-view').show();
            $('#table-preview-view, #eda-view').hide();
        });

        // Inicializar DataTables en la tabla de vista previa si está visible
        if ("{{ active_view }}" === "table-preview-view") {
            initializeDataTable();
        }

        // Ocultar inicialmente los elementos de EDA
        $('#eda-view .form-group:not(:first)').hide();

        // Función para enviar la solicitud AJAX con las fechas seleccionadas
        function sendAjaxRequestWithDates(dateRange) {
            var selectedTimestampColumn = $('#timestamp-column').val();
            var ajaxUrl = buildAjaxUrl(); // Construir la URL para la solicitud AJAX
            var csrftoken = $('#csrf-form [name=csrfmiddlewaretoken]').val(); // Obtener el token CSRF

            $.ajax({
                url: ajaxUrl,
                type: 'POST',
                data: {
                    'timestamp_column': selectedTimestampColumn,
                    'date_range': dateRange,
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken); // Establecer el token CSRF
                },
                success: function(response) {
                    // Procesar la respuesta del servidor
                    handleAjaxResponse(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error en la solicitud AJAX:", error); // Manejar errores
                }
            });
        }

        // Función para construir la URL de la solicitud AJAX
        function buildAjaxUrl() {
            var pathArray = window.location.pathname.split('/').filter(function(e) { return e; });
            var ajaxUrlBase = '/preprocess_dataset/';
            return ajaxUrlBase + pathArray.slice(1).join('/') + '/';
        }

        // Función para manejar la respuesta del servidor
        function handleAjaxResponse(response) {
            // Actualizar la interfaz con las fechas recibidas del servidor
            $('#date-range-label').text(`Select Date Range (In dataset: ${response.min_date_dataset} to ${response.max_date_dataset}):`);
            flatpickrInstance.set("defaultDate", [response.min_date_dataset, response.max_date_dataset]);
            flatpickrInstance.set("minDate", response.min_date_dataset);
            flatpickrInstance.set("maxDate", response.max_date_dataset);
        }

        $('#timestamp-column').change(function() {
            toggleEdaElements(); // Maneja los cambios visuales en la interfaz de usuario
    
            var selectedTimestampColumn = $(this).val();
            var dateRange = $('#date-range').val(); // Asume que el rango de fechas está en este input
    
            // Construir la base de la URL para la solicitud AJAX
            var ajaxUrl = buildAjaxUrl();
    
            // Obtener el token CSRF del formulario oculto
            var csrftoken = $('#csrf-form [name=csrfmiddlewaretoken]').val();
    
            // Enviar una solicitud AJAX al backend
            $.ajax({
                url: ajaxUrl,
                type: 'POST',
                data: {
                    'timestamp_column': selectedTimestampColumn,
                    'date_range': dateRange,
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                },
                success: function(response) {
                    console.log("Respuesta AJAX:", response);
                    handleAjaxResponse(response);
                },
                error: function(xhr, status, error) {
                    // Manejar posibles errores aquí
                    console.error("Error en la solicitud AJAX:", error);
                }
            });
        });
    });
</script>



{% endblock %}