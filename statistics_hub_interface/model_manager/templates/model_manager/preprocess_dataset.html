{% load static %}

{% block head %}
<style>
    body {
        background-color: #f4f4f4; 
    }

    .form-section, #eda-view, #preprocessing-view {
        margin-top: 20px;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
    }

    .form-group {
        margin-bottom: 10px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input, 
    .form-group select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .form-group button, .view-selector button {
        background-color: #4CAF50; /* Green */
        color: white;
        padding: 14px 20px;
        margin: 8px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .form-group button:hover, .view-selector button:hover {
        background-color: #45a049;
    }

    .view-selector {
        text-align: center;
        margin-bottom: 20px;
    }

    #table-preview-view, #eda-view, #preprocessing-view {
        display: none;
    }
</style>
<!-- Añadir jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<!-- Añadir DataTables CSS y JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>

<!-- Añadir Flatpickr CSS y JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}

<div class="container">

    <div class="view-selector">
        <button id="show-table-preview">Table Preview</button>
        <button id="show-eda-view">EDA</button>
        <button id="show-preprocessing-view">Preprocessing</button>
    </div>
    <ul>
        <li> #ToDo: Continuar con la carga "perezosa" de los datos y manetener la estética de los Datatables. 
             Actualmente se muestran solo las primeras 1000 filas. </li>
    </ul>
    <!-- Sección de Vista Previa de la Tabla -->
    <div class="form-section" id="table-preview-view" style="display:none;">
        <!-- Mostrar el DataFrame aquí -->
        {{ df_html|safe }}
    </div>

    <!-- Sección de EDA (Exploratory Data Analysis) -->
    <div id="eda-view" style="display:none;">
        <!-- Selección de Columna Timestamp -->
        <div class="form-group">
            <label for="timestamp-column">Timestamp Column:</label>
            <select id="timestamp-column" name="timestamp_column" class="form-control" onchange="updateDateRange();">
                <option value="">Seleccione una columna</option>
                {% for column in columns %}
                <option value="{{ column }}">{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Rango de Fechas -->
        <div class="form-group">
            <label for="date-range">Select Date Range:</label>
            <input type="text" id="date-range" name="date_range" class="date-range-selector">
        </div>
        
        <!-- Área de Filtros Dinámicos -->
        <div class="form-group">
            <label for="dynamic-filters">Filters:</label>
            <div id="dynamic-filters">
                <!-- Los filtros se añadirán aquí dinámicamente -->
            </div>
            <button type="button" id="add-filter">Add Filter</button>
        </div>
        
        <!-- Botón de Envío -->
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Analyze</button>
        </div>
    </form>
    </div>

    <!-- Sección de Preprocesamiento -->
    <div id="preprocessing-view" style="display:none;">
        <!-- Contenido para Preprocesamiento -->
    </div>
</div>

<script>
    $(document).ready(function() {
        var tableInitialized = false;
        var currentAction = 'show-table-preview';

        function initializeDataTable() {
            console.log("Inicializando DataTables");
            $('#table-preview-view .my-data-table').DataTable({
                // Configuración de DataTables...
            });
            tableInitialized = true;
        }

        // Inicializar DataTables si la tabla está visible al cargar la página
        if ($('#table-preview-view').is(':visible')) {
            initializeDataTable();
        }

        // Actualizar la sección visible en base a la acción
        function updateSection(action) {
            var currentUrl = window.location.href;
        
            if (action === 'show-table-preview' && !tableInitialized) {
                $.ajax({
                    url: currentUrl,
                    type: 'GET',
                    data: { 'action': action },
                    success: function(response) {
                        $('#table-preview-view').html(response.df_html);
                        initializeDataTable();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error en AJAX:', status, error);
                    }
                });
            } else if (action === 'show-eda-view') {
                var selectedTimestampColumn = $('#timestamp-column').val(); // Asume que tienes un selector para elegir la columna de timestamp
                $.ajax({
                    url: currentUrl,
                    type: 'GET',
                    data: {
                        'action': action,
                        'selected_dataset': '{{ selected_dataset }}',
                        'separator': '{{ separator }}',
                        'timestamp_column': selectedTimestampColumn
                    },
                    success: function(response) {
                        // Asumiendo que tu backend devuelve las fechas mínima y máxima
                        if (response.min_date && response.max_date) {
                            $(".date-range-selector").flatpickr({
                                mode: "range",
                                minDate: response.min_date,
                                maxDate: response.max_date,
                                dateFormat: "Y-m-d",
                            });
                        } else {
                            // Manejar el caso en que no se encuentren fechas mínima y máxima
                            console.log('Fechas mínima y máxima no encontradas');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error en AJAX:', status, error);
                    }
                });
            }
            // Puedes continuar con otras acciones aquí...
        }

        $('#show-table-preview').click(function() {
            console.log('show-table-preview clicked');
            event.preventDefault();
            currentAction = 'show-table-preview';
            updateSection(currentAction);
            $('#table-preview-view').show();
            $('#eda-view').hide();
            $('#preprocessing-view').hide();
        });

        $('#show-eda-view').click(function() {
            console.log('show-eda-view clicked');
            currentAction = 'show-eda-view';
            updateSection(currentAction);
            $('#eda-view').show();
            $('#table-preview-view').hide();
            $('#preprocessing-view').hide();
            $("#eda-view .form-group").not(':first').hide();
        });

        $('#show-preprocessing-view').click(function() {
            console.log('show-preprocessing-view clicked');
            currentAction = 'show-preprocessing-view';
            updateSection(currentAction);
            $('#preprocessing-view').show();
            $('#table-preview-view').hide();
            $('#eda-view').hide();
        });

        $('#timestamp-column').change(function() {
            if ($(this).val() != "") {
                $("#eda-view .form-group").not(':first').show();
                updateDateRange();
            } else {
                $("#eda-view .form-group").not(':first').hide();
            }
        });

        function updateDateRange() {
            var selectedColumn = $('#timestamp-column').val();
            var currentPath = window.location.pathname;

            $.ajax({
                url: currentPath,
                type: 'GET',
                data: {
                    'selected_dataset': '{{ selected_dataset }}',
                    'separator': '{{ separator }}',
                    'timestamp_column': selectedColumn,
                    'action': getCurrentAction() 
                },
                success: function(response) {
                    console.log(response);
                    $(".date-range-selector").flatpickr({
                        mode: "range",
                        minDate: response.min_date,
                        maxDate: response.max_date,
                        dateFormat: "Y-m-d",
                    });
                }
            });
        }

        // Función para obtener la acción actual
        function getCurrentAction() {
            return currentAction;
        }

        // Más lógica basada en la acción actual puede ser agregada aquí
    });
</script>


{% endblock %}
